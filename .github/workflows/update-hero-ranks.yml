name: Update Hero Ranks Daily

on:
  schedule:
    # Runs every day at 3:00 AM UTC (6:00 AM Kyiv time)
    - cron: '0 3 * * *'
  
  # Allows manual trigger from Actions tab
  workflow_dispatch:
    inputs:
      days:
        description: 'Period (days)'
        required: false
        default: '7'
        type: choice
        options:
          - '1'
          - '3'
          - '7'
          - '15'
          - '30'
      rank:
        description: 'Rank category'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'epic'
          - 'legend'
          - 'mythic'
          - 'honor'
          - 'glory'

jobs:
  update-ranks:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üèÜ Update Hero Ranks
        id: update
        run: |
          DAYS="${{ github.event.inputs.days || '7' }}"
          RANK="${{ github.event.inputs.rank || 'all' }}"
          
          echo "üîÑ Updating hero ranks..."
          echo "   Period: $DAYS days"
          echo "   Rank: $RANK"
          
          RESPONSE=$(curl -X POST https://web-production-8570.up.railway.app/api/hero-ranks/update \
            -H "Content-Type: application/json" \
            -d "{
              \"game_id\": 2,
              \"days\": $DAYS,
              \"rank\": \"$RANK\",
              \"sort_field\": \"win_rate\"
            }" \
            -s -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "response=$BODY" >> $GITHUB_OUTPUT
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "202" ]; then
            echo "‚ùå Update failed with status $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi
          
          echo "$BODY" | jq '.'
          
          if [ "$HTTP_CODE" == "202" ]; then
            echo ""
            echo "‚úÖ Update request accepted and processing in background!"
            MESSAGE=$(echo "$BODY" | jq -r '.message')
            echo "   $MESSAGE"
          else
            INSERTED=$(echo "$BODY" | jq -r '.inserted // 0')
            UPDATED=$(echo "$BODY" | jq -r '.updated // 0')
            SKIPPED=$(echo "$BODY" | jq -r '.skipped // 0')
            
            echo ""
            echo "‚úÖ Update successful!"
            echo "   Inserted: $INSERTED"
            echo "   Updated: $UPDATED"
            echo "   Skipped: $SKIPPED"
          fi

      - name: üìä Verify Current Stats
        if: success()
        run: |
          echo "üîç Fetching top 5 heroes..."
          
          curl -s "https://web-production-8570.up.railway.app/api/hero-ranks?game_id=2&size=5" | \
            jq -r '.data[] | "\(.name): \(.win_rate * 100 | floor)% WR"'

      - name: ‚è∞ Update Timestamp
        if: success()
        run: |
          echo "Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > .github/last-update.txt
          cat .github/last-update.txt

      # Optional: Send notification to Discord
      # - name: üì¢ Send Discord Notification
      #   if: always()
      #   env:
      #     DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      #   run: |
      #     if [ "${{ steps.update.outcome }}" == "success" ]; then
      #       STATUS="‚úÖ Success"
      #       COLOR=3066993
      #     else
      #       STATUS="‚ùå Failed"
      #       COLOR=15158332
      #     fi
      #     
      #     BODY='${{ steps.update.outputs.response }}'
      #     INSERTED=$(echo "$BODY" | jq -r '.inserted // 0')
      #     UPDATED=$(echo "$BODY" | jq -r '.updated // 0')
      #     
      #     curl -H "Content-Type: application/json" \
      #       -d "{
      #         \"embeds\": [{
      #           \"title\": \"üèÜ Hero Ranks Update\",
      #           \"description\": \"$STATUS\",
      #           \"color\": $COLOR,
      #           \"fields\": [
      #             {\"name\": \"Inserted\", \"value\": \"$INSERTED\", \"inline\": true},
      #             {\"name\": \"Updated\", \"value\": \"$UPDATED\", \"inline\": true}
      #           ],
      #           \"timestamp\": \"$(date -u '+%Y-%m-%dT%H:%M:%S.000Z')\"
      #         }]
      #       }" \
      #       "$DISCORD_WEBHOOK"
