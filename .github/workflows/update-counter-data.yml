name: Update Counter Data Daily

on:
  schedule:
    # Runs every day at 4:00 AM UTC (7:00 AM Kyiv time) - Ð¿Ñ–ÑÐ»Ñ hero ranks
    - cron: '0 4 * * *'
  
  # Allows manual trigger
  workflow_dispatch:

jobs:
  update-counter-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Update Counter & Compatibility Data
        id: update
        run: |
          echo "ðŸ”„ Updating counter and compatibility data..."
          
          MAX_RETRIES=3
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "   Attempt $i of $MAX_RETRIES..."
            
            RESPONSE=$(curl -X POST https://web-production-8570.up.railway.app/api/heroes/update-counter-data \
              -H "Content-Type: application/json" \
              -d '{"game_id": 2}' \
              --connect-timeout 15 \
              --max-time 30 \
              -s -w "\n%{http_code}" || true)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" == "202" ]; then
              break
            fi
            
            if [ "$i" -lt "$MAX_RETRIES" ]; then
              echo "   âš ï¸ Attempt $i failed (HTTP $HTTP_CODE), retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
          done
          
          echo "response=$BODY" >> $GITHUB_OUTPUT
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "202" ]; then
            echo "âŒ Update failed with status $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi
          
          echo "$BODY" | jq '.'
          echo ""
          echo "âœ… Update started in background!"
          echo "   Data will be updated in a few minutes."

      - name: â° Update Timestamp
        if: success()
        run: |
          echo "Counter data update started: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > .github/last-counter-update.txt
          cat .github/last-counter-update.txt
